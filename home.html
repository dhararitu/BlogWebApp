
  <!--  Create your own Blog post area starts here-->
  <div class="jumbotron bg-dark" style="margin-top:15px;">
    <script>
        var counter =0;
    </script>
    <div class="container text-center">
   <form action="" id="main-form">
   <div class="form-group">
   <textarea name="description" type="text" placeholder="Description....." id="main-desc"  rows="5" class="form-control"></textarea>
   <div class="invalid-feedback">
    Please write some description first
   </div>
   </div>
   <div class="form-group">
     <input type="file" class="form-control" id="main-image">
     <div class="invalid-feedback">
      Please choose a valid picture
     </div>
   </div>
   <div class="form-control">
  <img id="selected-image" width="250" height="150" src="#" alt="">
   </div>
   <div class="form-group">
    <div class="progress bg-container">
     <div class="progress-bar bg-success" id="upload-progress" style="width:0;">
        0%
     </div>
    </div>
   </div>
   <div class="form-group">
  <button id="save-blog" type="button" style="width:150px; height: 60px;" class="btn btn-light bg-light text-dark">Post</button>
   </div>
   </form>
   <div id="result">

   </div>
    </div>

  </div>
  <!-- Create your own Blog post area ends here -->
  <!-- All blog post area starts here -->
  <hr>
  <br><br><br>
  <div class="text-center bg-light text-dark">
   <h3>All New Blogs</h3>
  </div>
  <hr>
  <br>
  <!-- Filter input -->
<label for="publisherFilter">Filter by Publisher Name:</label>
<input type="text" id="publisherFilter" class="form-control">
<br>
<button id="applyFilter" class="btn btn-primary">Apply Filter</button>
<br>
<br>
<label for="sortBlogs">Sort By:</label>
<select id="sortBlogs" class="form-control">
  <option value="default">Default</option>
  <option value="dateAsc">Date & Time(Ascending)</option>
  <option value="dateDesc">Date & Time (Descending)</option>
</select>
<br>
<br>


  <div class="row container-fluid bg-3">
  <div class="col-sm-12" id="blogs">

  </div>
  </div>
  <br>
  
  <!-- All blog post area ends here -->
  <!-- validation and uploading of post blog starts here -->
  <script>
    var validImagetypes = ["image/gif","image/jpeg","image/png"];
    $("#selected-image").hide();
    function previewImage(image_blog){
       if(image_blog.files && image_blog.files[0]){
        var reader = new FileReader();
        reader.onload = function(e){
            $("#selected-image").attr('src',e.target.result);
            $("#selected-image").fadeIn();
        }
        reader.readAsDataURL(image_blog.files[0]); 
       
       }
    }
    $("#main-image").change(function(){
        previewImage(this);
    });
    $("#save-blog").click(function(){
        $("#main-desc").removeClass("is-invalid");
        $("#main-image").removeClass("is-invalid");
        var desc = $("#main-desc").val();
        var picture = $("#main-image").prop("files")[0];
        if(!desc){
            $("#main-desc").addClass("is-invalid");
            return;
        }
        if(picture == null){
            $("#main-image").addClass("is-invalid");
            return;
        }
        if($.inArray(picture["type"],validImagetypes)<0){
            $("#main-image").addClass("is-invalid");
            return;
        }
         // upload and store it to the firebage storage and firebase database starts here//
     var databaseRef = firebase.database().ref().child("Blogs");
     databaseRef.once("value").then(function(snapshot){
       var name = picture["name"];
       var dateStr = new Date().getTime();
       var fileCompleteName = name + "_" + dateStr;
       var storageRef = firebase.storage().ref("Blog Images");
       var blogStorageRef = storageRef.child(fileCompleteName);
       var uploadTask = blogStorageRef.put(picture);
       uploadTask.on("state_changed",
        function progress(snapshot){
            var percentage = (snapshot.bytesTransferred / snapshot.totalBytes)*100;
            $("#upload-progress").html(Math.round(percentage) + "%");
            $("#upload-progress").attr("style","width:" + percentage + "%");

        },
        function error(err)
        {
            
        },
        function complete(){
            var user = firebase.auth().currentUser;
            var userName;
            firebase.database().ref('Users/' + user.uid).once('value').then(function(snapshot){
               var firstName = (snapshot.val() && snapshot.val().firstName);
               var secondName = (snapshot.val() && snapshot.val().secondName);
               userName = firstName + " " + secondName;

            });
            uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL){
           var time = new Date();
           var options = 
           {
            weekday: "long",
            month: "long",
            day: "2-digit",
            year: "numeric",
           }; 
           
           var blogData = {
             "image": downloadURL,
             "name": fileCompleteName,
             "desc": desc,
             "uid": user.uid,
             "counter":5000 - counter,
             "userName": userName,
             "time": time.toLocaleString('en-US', {hour: 'numeric',minute: 'numeric',hour12: 'true'}),
             "date": time.toLocaleDateString('en-US', options),
           };
           var newPostRef = databaseRef.push();
           newPostRef.set(blogData,function(err){
              if(err){
                $("#result").attr("class","alert alert-danger");
                $("#result").html(err.message); 

              }
              else{
                $("#result").attr("class","alert alert-success");
                $("#result").html("blog has been uploaded successfully");
                window.open("", "_self"); 

              }
              resetForm();
           });
            });
        });
     });
     // upload and store it to the firebage storage and firebase database ends here//

    });
    
    function resetForm(){
        $("#main-form")[0].reset();
        $("#selected-image").fadeOut();
        $("#upload-progress").html("Completed");
    }
    //  retrive and display data from firebase starts here//
     var dbBlogs = firebase.database().ref().child("Blogs").orderByChild("counter");
     var sortBy = "default";

function displayBlogs(publisherFilter) {
  dbBlogs.on("value", function (blogs) {
    if (blogs.exists()) {
      var blogsArray = [];

      blogs.forEach(function (singleBlog) {
        if (!publisherFilter || singleBlog.val().userName.includes(publisherFilter)) {
          blogsArray.push(singleBlog.val());
        }
      });

      // Sort the blogs based on the sortBy value
      if (sortBy === "dateAsc") {
        blogsArray.sort(function (a, b) {
          return new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time);
        });
      } else if (sortBy === "dateDesc") {
        blogsArray.sort(function (a, b) {
          return new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time);
        });
      }

      var blogsHtml = "";
      blogsArray.forEach(function (singleBlog) {
        blogsHtml += "<div class='jumbotron bg-light text-dark'>";
        blogsHtml += "<img width='1000px' height='550px' src='" + singleBlog.image + "'/></div> <br>";
        blogsHtml += "<div class='row'>";
        blogsHtml += "<div class='col-sm-5'><p style='color:grey;'>Published By: " + singleBlog.userName + "</p></div>" +
            "<div class='col-sm-3'><p style='color:grey;'>Time: " + singleBlog.time + "</p></div>" +
            "<div class='col-sm-4'><p style='color:grey; margin-left: 85px;'>Date: " + singleBlog.date + "</p></div>";
        blogsHtml += "</div> <br>";
        blogsHtml += "<div style='text-align:justify; color:black;'>";
        blogsHtml += singleBlog.desc;
        blogsHtml += "</div> <br>";
        blogsHtml += "</div>";
      });

      $("#blogs").html(blogsHtml);
    }
  });
}

document.getElementById('applyFilter').addEventListener('click', function () {
  var publisherFilter = document.getElementById('publisherFilter').value;
  displayBlogs(publisherFilter);
});

document.getElementById('sortBlogs').addEventListener('change', function () {
  sortBy = this.value;
  displayBlogs(document.getElementById('publisherFilter').value);
});

// Initial display without filters
displayBlogs(null);
    //  retrive and display data from firebase ends here//
  </script>
  <!-- validation and uploading of post blog ends here -->
